# 故障排除

> `Visual Studio` 由于预热机制，`Docker`模式下**边车仅启动一次，除非自行重启，边车是不会重读配置的**。比如监听领域事件。

## 常见错误

### Fatal error from runtime: failed to retrieve the initial identity certificate: error from sentry SignCertificate: rpc error: code = PermissionDenied desc = failed to get configuration

查看`dapr-sentry`的日志发现有个配置读取不到，因为命名空间不对。

### Requesting HTTP version 2.0 with version policy RequestVersionOrHigher while unable to establish HTTP/2 connection

可能是使用了 `http_proxy`和 `https_proxy` 的原因
`.NET populates the HttpClient DefaultProxy from these environment variables. My company proxy appears to be interfering with HTTP/2 (unsupported?), preventing gRPC from working correctly. The workaround for local development is to manually set the default proxy for the HttpClient before making the gRPC call:`

```csharp
HttpClient.DefaultProxy = new WebProxy();
```

### multipart/form-data lost file data

通过 `Apisix` 调用 `Dapr` 边车后发现 `postman`上传文件丢失了文件内容，发现如果`form`中不传`key`值，会丢失文件内容。如果带`key`，则能正常接收到，但内部文件内容多加了一些信息，需要处理。

### Grpc.Core.RpcException: Status(StatusCode=\"ResourceExhausted\", Detail=\"grpc: received message larger than max (9615510 vs. 4194304)\")

setting parameters `daprHTTPMaxRequestSize` and `UseGrpcChannelOptions` with higher data size

```cs
 services.AddDaprClient(builder => builder.UseGrpcChannelOptions(new GrpcChannelOptions()
 {
     MaxReceiveMessageSize = 100 * 1024 * 1024,
     MaxSendMessageSize = 100 * 1024 * 1024,
     MaxRetryBufferSize = 100 * 1024 * 1024
     
 }));
```

### ERROR_HEALTH_NOT_READY  无法启动边车等

#### 端口占用

滚动更新时，启动边车失败？猜测是`Dapr`无法注册端口被占用问题？`K8S`还是`Dapr bug`？
解决方案：干掉旧的，单独起新的：可将副本数置为0后更新。

#### 容器端口不对

比如配置了环境变量监听80但是容器配的是8080等问题。

### 调用超时爆炸，瘫痪

微服务调用一定要避免成环路的情况。

### invoke failed Transport: authentication handshake failed: x509: certificate has expired

更新了`dapr-system` `control panel`但未重启边车。

### K8S daprd 边车消失 无显示

检查 `yaml` 文件 `annotation` 无异常，重启后时不时可以重新出现。
实际上是边车注入失败，具体可以看`dapr-sidecar-injector`的日志，目前遇到的问题有：
`Sidecar injector failed to inject for app 'xxxx'. Error: error from sentry SignCertificate: rpc error: code = Canceled desc = context canceled`

具体原因未知。
[Dapr 1.12.4 fail randomly to assign a sidecar - error from sentry SignCertificate · Issue #7444 · dapr/dapr (github.com)](https://github.com/dapr/dapr/issues/7444)
有一个解决办法：使用`Dapr`提供的一个`feature: injector watch dog`
[Dapr Operator control plane service overview | Dapr Docs](https://docs.dapr.io/concepts/dapr-services/operator/#injector-watchdog)

### initial http2 frame frame server is not a settings frame: \*http2.GoAwayFrame

使用容器起来进行远程调用时，`Dapr`直接返回该错误。原因是因为容器`override`配置中`Dapr`配置了`app-protocol=grpc`，而实际上程序未启用`gRPC`方式返回数据。

### 调试时事件发布有时候丢失

看是否一个消费者组有多个消费者，默认行为同实例的会竞争事件。

### docker中边车突然关闭退出且无相关日志

是否是`docker-compose`中设置了内存限制，到达了限制后被自动结束程序