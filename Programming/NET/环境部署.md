# 环境部署



## 启动


### app freezes on a no-internet WiFi

- **The app freezes on a no-internet WiFi likely due to Windows performing Certificate Revocation List (CRL) checks on signed assemblies during startup.** These checks attempt to verify if certificates used to sign .NET components (like Microsoft assemblies) have been revoked, but without internet, they time out (up to 15-30 seconds per check, potentially multiple times), causing delays or apparent freezes before logging begins.
- **This is a Windows/.NET mechanism, not your code.** It's common in air-gapped or no-internet networks, affecting assembly loading at runtime. The network being "connected" but without internet triggers the timeout, while disabling the network skips the check.
- **Evidence suggests this is widespread but fixable.** Multiple sources confirm similar issues in .NET apps, including ASP.NET Core hosted in IIS or self-hosted, with delays resolved by disabling CRL checks.

To disable CRL checks machine-wide (recommended for testing; revert in production for security):

1. Open **Control Panel > Internet Options** (or search for "Internet Options").
2. Go to the **Advanced** tab.
3. Scroll to the **Security** section.
4. Uncheck **"Check for publisher's certificate revocation"** and optionally **"Check for signatures on downloaded programs"**.
5. Click **Apply** > **OK**, then restart your app.

If the app runs under a specific user (e.g., service account), apply this per-user via their profile.

> 似乎无效，以下方法待验证

#### Disabling CRL lookups 

To disable CRL lookups on the Symantec Management Platform computer, you need to edit the machine.config file on the computer, as follows:

1. Open the _machine.config_ file in a text editor.  
	The _machine.config_ file is located at _%runtime install path%\Config\machine.config_, where the runtime install path is usually _C:\Windows\Microsoft.NET\Framework\v2.0.50727\CONFIG_.  
2. Edit the XML of the _machine.config_ file:  
Find the `<runtime>` node.  
If it looks like `<runtime/>`, replace it with:  
```
<runtime>   
    <generatePublisherEvidence enabled="false"/>   
</runtime>
```
otherwise, simply add:  
`<generatePublisherEvidence enabled="false"/> `
between the start and end tags.


## 还原

如果远程`nuget`包管理服务器挂掉，发现项目无法还原，应要添加本地nuget包缓存到Nuget配置，默认是没有添加的。nuget包缓存一般在用户目录下`C:\Users\YourName\.nuget\packages`。
或通过`--source`命令可以强行指定该目录临时还原。



### error NU1302

> NuGet 需要 HTTPS 源。要使用 HTTP 源，必须在 NuGet.Config 文件中将“allowInsecureConnections”显式设置为 true。

项目下需要自行新建一个Nuget.Config文件，通过CLI命令无法忽略该错误。

如果命令行还原成功，但是`Visual Studio`下仍然出现此问题，还需要使用 `everything` 去搜索 C 盘下的 `Nuget.Config` 文件去修改设置。


### 缓存问题

如果发现自己的 `nexus` 仓库已经更新，但是 `restore` 还是爆不存在，是 nuget 的缓存问题。需要命令使用 `dotnet restore --no-http-cache`


## 证书

`dotnet dev-certs https --trust`


## 构建

```csharp
dotnet build --nologo -v q --property WarningLevel=0 /clp:ErrorsOnly
```

- `--property:<NAME>=<VALUE>` to pass properties to MSBuild ([https://learn.microsoft.com/en-us/dotnet/core/tools/dotnet-run](https://learn.microsoft.com/en-us/dotnet/core/tools/dotnet-run))
- `WarningLevel=[0,1,2,3,4]` to configure the level of warnings to be output where `4` is the default and `0` disables all warnings ([https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/compiler-options/errors-warnings](https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/compiler-options/errors-warnings))
- `--nologo` suppresses the header
- `-v q` sets output verbosity to quiet
- `/clp:ErrorsOnly` means **C**onsole**L**ogger**P**arameters


## 命令

| command                                                   | function                | remark                                                                                                                                                      |
| --------------------------------------------------------- | ----------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `dotnet publish -c Release -r linux-arm --self-contained` | 编译出目标平台linux-arm的可运行程序  | change `linux-arm` with the runtime that is appropriate for your case if you install the `.NET` runtime in your container, you can avoid `--self-contained` |
| `dotnet restore \xx.csproj –packages .\packages`          | 还原指定项目所需依赖，并将依赖包保存到指定目录 |                                                                                                                                                             |
|                                                           |                         |                                                                                                                                                             |
|                                                           |                         |                                                                                                                                                             |
|                                                           |                         |                                                                                                                                                             |
|                                                           |                         |                                                                                                                                                             |



## 发布

请不要使用 `dotnet build -c Release` 来发布以及构建生产镜像！请通过 `dotnet publish`来发布。因为有很多行为不一致，如`RCL(Razor class library)`会生成 `wwwroot`文件夹等。

### 发布单体程序

```bash
dotnet publish -r win10-x64 -p:PublishSingleFile=true
```
