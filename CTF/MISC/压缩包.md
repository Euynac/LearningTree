# ZIP
## 简介

ZIP文件格式是一种数据压缩和文档储存的文件格式，原名Deflate，发明者为菲尔·卡茨（Phil Katz），他于1989年1月公布了该格式的资料。ZIP通常使用后缀名“.zip”，它的MIME格式为`application/zip`。
## 结构

![](../../attachments/Pasted%20image%2020230804210215.png)
从上图我们可以看到，ZIP文件各组成部分之间是有对应关系的。数据存储区包含多个**文件实体**（File Entry）而一个被压缩的文件对应一个文件实体，一个文件实体又对应一个文件实体头。中心目录区包含多个文件头。
[ZIP文件结构解析 - 枫のBlog (goodapple.top)](https://goodapple.top/archives/700)

### 数据存储区

#### Local File Header (50 4B 03 04)
实体文件头中包含着文件的各种信息，包括文件名称、解压缩版本、压缩方式、CRC等等

#### File Data

文件数据从`66 6C`开始，一直到末尾的换行符`0A`。

#### Data descriptor (50 4B 07 08)

用于表示文件压缩结束，只有在文件实体头中通用标记位的第3Bit位为1时才会出现。一般zip上没有这个数据描述符，对应的编码格式如下。

### 中心目录区
中心目录区通常由多个文件头（File Header）组成。主要记录被压缩文件的目录结构，以及被压缩文件的属性，包括文件长度，压缩之后的长度，文件注释等。一个文件实体与一个文件头相对应。
#### FIle Header (50 4B 01 02)

文件头和实体文件头十分类似，它比实体文件头多记录了一些文件信息。
#### Digital Signature

通常由头标识`50 4B 05 05`开始

### 目录结束标识 (50 4B 05 06)

在中心目录区结束后，目录结束标识用于标记目录数据的结束，每个压缩文件有且只有一个。

## 隐写

### NTFS流隐写


## 加密

### 字典攻击

#### 简单密码字典
准备一些常用的简单密码字典，对于某些提示“简单”加密文件的可能有用。

#### 构造符合条件要求的字典

### 暴力破解
#### 简单密码

尝试使用ARCHPR的默认配置跑跑，4-6位，大小写，数字。如果不行可以尝试字典攻击。

#### 掩码攻击

只知道一部分明文，未知部分进行暴力。
如果使用`ARCHPR`工具，掩码长度有限制，这时候可以写脚本转换为字典攻击。

#### CRC爆破
如果里面存的数据很小（似乎小于10字节？要研究一下），可以采用它的CRC进行爆破直接得到数据明文。

```python
  from zlib import crc32 2 import random 3 
  char='0123456789'
  
  def crc32_f(data):      
	  return hex(crc32(data)&0xffffffff)[2:10]
  
 length=input('length:')
 crc32_=raw_input('crc32:').lower()
 
 while True:
     text=''
     for i in range(length):
         text+=char[random.randint(0,len(char)-1)]
     if crc32_f(text)==crc32_:
         raw_input('find it:'+text)
         exit
```


### 伪加密

![](../../attachments/Pasted%20image%2020230709005551.png)
加密标志位是在`数据存储区`和`中心目录区`两块地方的`全局方式位标记(General purpose bit flag)`。
一般来说伪加密是中心目录区的标志位是奇数，而数据存储区的标志位是偶数
> PS: 但其实不一定，两个都是奇数的，所有工具都打不开，但是将第二蓝线手动修改成00又能够打开了。




# RAR
[(´∇｀) RAR文件格式分析 | Sp4n9x's Blog](https://sp4n9x.github.io/2020/04/10/RAR%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E6%9E%90/)

## 伪加密
`伪加密`一般发生在`RAR5.0以前的版本`中，我们只需要修改`FILE_HEAD`中的`HEAD_FLAGS`的`0x0004`标记为1，就可以造成`RAR伪加密`。注意将CRC校验值改为一致。

5.0的伪加密还没遇到过，应该是比较难实现的。因为要改动的地方很多。

## 隐写
#### NTFS流隐写

NTFS流隐写的压缩包用winrar或7zip等支持的才能看到隐藏的文件，而其他比如banzip则看不到。
![](../../attachments/Pasted%20image%2020230808001803.png)

#### HeadType隐写
有一道例题，打开文件只有一个txt文件，实际上还藏了另一个文件，但是看不到，通过结构可以看到这里的`HeadType`类型被改成了`SubBlock`，导致看不到文件。
![](../../attachments/Pasted%20image%2020230808001056.png)